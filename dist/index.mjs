var p=(a,n,e)=>new Promise((i,d)=>{var u=l=>{try{V(e.next(l))}catch(s){d(s)}},t=l=>{try{V(e.throw(l))}catch(s){d(s)}},V=l=>l.done?i(l.value):Promise.resolve(l.value).then(u,t);V((e=e.apply(a,n)).next())});function x(a){let n=0,e;return(...i)=>{var u;let d=++n;return e=(u=e==null?void 0:e.then(()=>{if(n==d)return e=a(...i).then(t=>(e=void 0,t)),e}))!=null?u:a(...i).then(t=>(e=void 0,t)),e}}function F(a,n){let e=0,i;return(...d)=>new Promise(u=>{let t=++e,V=new Date().getTime();i!=null||(i=V-n);let l=V-i-n;l<0?new Promise(s=>setTimeout(s,-1*l)).then(()=>{i=new Date().getTime(),t==e&&u(a(...d)),u(void 0)}):(i=V,u(a(...d)))})}function h(a,n=e=>e){return a.reduce((e,i)=>{if(i!=null){let d=n(i);d!=null&&e.push(d)}return e},[])}function I(a){return a.reduce((n,e)=>{if(e!=null)if(e instanceof Array)for(let i of e)i!=null&&n.push(i);else n.push(e);return n},[])}function M(a){return n=>{var i;let e=String((i=n.value)!=null?i:"");return{isValid:e.length>=a,errorMessage:`Too short (${e.length} / ${a})`}}}import{ref as g,computed as m,watch as j,reactive as b}from"vue";var w=g(0);function k(a){var P;(P=a.delayReactiveValidation)!=null||(a.delayReactiveValidation=!0);let{objectToValidate:n,validation:e,delayReactiveValidation:i,args:d}=a,u=g(!1),t=m(()=>l.some(R=>R.validationState.isValidating)),V=m(()=>l.every(A=>A.reactiveIsValid.value&&A.lazyIsValid.value)),l=[],s=b({}),y=g(JSON.stringify(a.objectToValidate.value)),o=m(()=>y.value!==JSON.stringify(a.objectToValidate.value));if((e==null?void 0:e.$reactive)!=null||(e==null?void 0:e.$lazy)!=null){let v=$(n,e);s=b(v.validationState),l=[v]}else{let R=n,A=e,v=O(R.value,A);s=b(v.state),l=v.validationConfigs}j(a.objectToValidate,()=>{i?u.value==!0&&K(l,n,d,!0,!1):K(l,n,d,!0,!1)},{deep:!0});function c(){return p(this,null,function*(){let R=yield K(l,n,d,!0,!0);return u.value=!0,R})}function f(R){y.value=JSON.stringify(R)}return b({hasValidated:u,validate:c,isValidating:t,propertyState:s,isValid:V,setReference:f,isDirty:o})}function B(a,n,e,i){return p(this,null,function*(){var y,o;if(a.validation.$reactive==null)return!0;a.validatingReactive.value=!0;let d=a.validation.$reactive,u=!0;(a.syncValidators.$reactive||a.asyncValidators.$reactive)&&(u=!1,d=((y=a.syncValidators.$reactive)!=null?y:[]).concat((o=a.asyncValidators.$reactive)!=null?o:[]));let t=!0,V=0;function l(r){let c;if(i==a.validationIterationId)for(let f=0;f<r.length;f++)r[f].isValid==!1&&(t=!1),r[f].identifier=`validator-reactive-${a.id}-${V++}`,c=a.reactiveValidationResults.value.find(P=>P.identifier==r[f].identifier),c!=null?Object.assign(c,r[f]):a.reactiveValidationResults.value.push(r[f])}let s=G(a.property.value,n,e,d,l);if(u){let r=[];for(let c of s.asyncValidators)r.push(F(c,1e3));a.asyncValidators.$reactive=r,a.syncValidators.$reactive=s.syncValidators}return l(s.syncResults),yield Promise.all(s.asyncPromises),i==a.validationIterationId&&(a.reactiveIsValid.value=t,a.validatingReactive.value=!1),a.reactiveIsValid.value})}function L(a,n,e,i){return p(this,null,function*(){var y,o;if(a.validation.$lazy==null)return!0;a.validatingLazy.value=!0;let d=!0,u=0,t=!0,V=a.validation.$lazy;(a.syncValidators.$lazy||a.asyncValidators.$lazy)&&(t=!1,V=((y=a.syncValidators.$lazy)!=null?y:[]).concat((o=a.asyncValidators.$lazy)!=null?o:[]));function l(r){let c;if(i==a.validationIterationId)for(let f=0;f<r.length;f++)r[f].isValid==!1&&(d=!1),r[f].identifier=`validator-lazy-${a.id}-${u++}`,c=a.lazyValidationResults.value.find(P=>P.identifier==r[f].identifier),c!=null?Object.assign(c,r[f]):a.lazyValidationResults.value.push(r[f])}let s=G(a.property.value,n,e,V,l);if(t){let r=[];for(let c of s.asyncValidators)r.push(F(c,500));a.asyncValidators.$lazy=r,a.syncValidators.$lazy=s.syncValidators}return l(s.syncResults),yield Promise.all(s.asyncPromises),i==a.validationIterationId&&(a.lazyIsValid.value=d,a.validatingLazy.value=!1),a.lazyIsValid.value})}function K(a,n,e,i,d){return p(this,null,function*(){let u=[];for(let t of a){let V=++t.validationIterationId;if(i&&u.push(B(t,n.value,e,V)),d&&u.push(L(t,n.value,e,V)),t.elementValidation!=null){let l=[];for(let s in t.arrayConfigMap)l.push(...t.arrayConfigMap[s].validationConfigs);u.push(K(l,n,e,i,d))}}return Promise.all(u).then(t=>t.every(V=>V==!0))})}function G(a,n,e,i=[],d){let u=[],t=[],V=[],l=[];for(let s of i){let y=s({value:a,parent:n,args:e});y instanceof Promise?(u.push(y.then(o=>o?d([o]):void 0)),l.push(s)):(t.push(y),V.push(s))}return{syncResults:t,asyncPromises:u,syncValidators:V,asyncValidators:l}}function $(a,n){var V,l,s,y;let e=n.$each!=null,i=b({isValid:m(()=>{var c,f;let o=(c=t.lazyIsValid.value)!=null?c:!1,r=(f=t.reactiveIsValid.value)!=null?f:!1;return o&&r}),isValidating:m(()=>t.validatingReactive.value||t.validatingLazy.value),isErrored:m(()=>i.validationResults.some(o=>o.isValid==!1)),errorMessages:m(()=>I(h(i.validationResults,o=>o.isValid?void 0:o.errorMessage))),validationResults:m(()=>{var o,r;return((o=t.reactiveValidationResults.value)!=null?o:[]).concat((r=t.lazyValidationResults.value)!=null?r:[])}),arrayState:m(()=>{if(Array.isArray(a.value)){let o=a.value,r=t.elementValidation,c=t.arrayConfigMap,f=(r==null?void 0:r.$reactive)!=null||(r==null?void 0:r.$lazy)!=null,P,R=[];for(let v=0;v<o.length;v++)if(o[v].$ffId===void 0&&Object.defineProperty(o[v],"$ffId",{value:`${t.id}-${t.elementId++}`,writable:!1,configurable:!1,enumerable:!1}),P=o[v].$ffId,R.push(P),!c[P])if(f){let S=r,z=m(()=>o[v]),T=$(z,S);c[P]={validationConfigs:[T],validationState:T.validationState}}else{let S=o[v],T=O(S,r);c[P]={validationConfigs:T.validationConfigs,validationState:T.state}}let A=[];for(let v=0;v<R.length;v++)A.push(c[R[v]].validationState);return A}else return})}),d=!(((l=(V=n.$lazy)==null?void 0:V.length)!=null?l:-1)>0),u=!(((y=(s=n.$reactive)==null?void 0:s.length)!=null?y:-1)>0),t={id:w.value++,validationIterationId:0,reactiveIsValid:g(u),reactiveValidationResults:g([]),validatingReactive:g(!1),lazyIsValid:g(d),lazyValidationResults:g([]),validatingLazy:g(!1),validation:n,syncValidators:{},asyncValidators:{},property:a,validationState:i,arrayConfigMap:{},hasElementValidation:e,elementId:0,elementValidation:n.$each};return t}function O(a,n){let e=[],i={};n!=null&&d(a,n);function d(u,t){var V,l;for(let s in t){let y=m(()=>u[s]),o=((V=t[s])==null?void 0:V.$reactive)!=null||((l=t[s])==null?void 0:l.$lazy)!=null;if(o){let r=t[s],c=$(y,r);e.push(c),i[s]=c.validationState}else if(o==!1){let r={},c=t[s];i[s]=r,d(y,c)}}}return{validationConfigs:e,state:i}}export{x as bufferAsync,M as minimumLength,F as throttleQueueAsync,k as useValidation};
